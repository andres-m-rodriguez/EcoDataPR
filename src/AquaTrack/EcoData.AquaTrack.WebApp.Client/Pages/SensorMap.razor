@page "/map"
@using EcoData.AquaTrack.Contracts.Dtos
@using EcoData.AquaTrack.Contracts.Parameters
@using EcoData.AquaTrack.Application.Client
@using EcoData.AquaTrack.WebApp.Client.Services
@using BlazingSingularity
@using BlazingSingularity.Commands
@inject ISensorHttpClient SensorClient
@inject IDataSourceHttpClient DataSourceClient
@inject ISensorMapManager MapManager
@implements IAsyncDisposable

<PageTitle>Map</PageTitle>

<div class="map-page">
    <div class="map-filter-panel">
        <MudPaper Elevation="2" Class="pa-3">
            <MudText Typo="Typo.subtitle1" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Size="Size.Small" Class="mr-1" />
                Data Sources
            </MudText>
            @if (LoadDataSourcesCommand.IsLoading)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
            }
            else if (_dataSources is not null && _dataSources.Count > 0)
            {
                <MudStack Spacing="1">
                    @foreach (var dataSource in _dataSources)
                    {
                        <MudCheckBox T="bool"
                                     Value="@IsDataSourceSelected(dataSource.Id)"
                                     ValueChanged="@((bool value) => OnDataSourceSelectionChanged(dataSource.Id, value))"
                                     Label="@dataSource.Name"
                                     Color="Color.Primary"
                                     Dense="true"
                                     Class="ma-0" />
                    }
                </MudStack>
                <MudDivider Class="my-2" />
                <MudStack Row="true" Spacing="1">
                    <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" OnClick="SelectAllDataSources">
                        Select All
                    </MudButton>
                    <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Secondary" OnClick="ClearAllDataSources">
                        Clear
                    </MudButton>
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">No data sources available</MudText>
            }
        </MudPaper>
    </div>
    <div class="map-container">
        @if (LoadSensorsCommand.IsLoading)
        {
            <MudOverlay Visible="true" DarkBackground="false">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            </MudOverlay>
        }
        <div id="sensor-map" class="map"></div>
    </div>
</div>

@code {
    private readonly CancellationTokenSource _cts = new();
    private List<SensorDtoForList>? _sensors;
    private IReadOnlyList<DataSourceDtoForList>? _dataSources;
    private HashSet<Guid> _selectedDataSourceIds = new();
    private bool _mapInitialized;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadDataSourcesCommand.ExecuteAsync(),
            LoadSensorsCommand.ExecuteAsync()
        );
    }

    [RelayCommand]
    private async Task LoadDataSources()
    {
        _dataSources = await DataSourceClient.GetDataSourcesAsync(_cts.Token);
        // Select all data sources by default
        _selectedDataSourceIds = _dataSources.Select(ds => ds.Id).ToHashSet();
    }

    [RelayCommand]
    private async Task LoadSensors()
    {
        var parameters = new SensorParameters(PageSize: 100, IsActive: true);
        _sensors = [];
        await foreach (var sensor in SensorClient.GetSensorsAsync(parameters, _cts.Token))
        {
            _sensors.Add(sensor);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!LoadSensorsCommand.IsLoading && !_mapInitialized && _sensors is not null)
        {
            _mapInitialized = true;
            await MapManager.InitializeAsync("sensor-map");
            await UpdateMapSensorsAsync();
        }
    }

    private bool IsDataSourceSelected(Guid dataSourceId)
    {
        return _selectedDataSourceIds.Contains(dataSourceId);
    }

    private async Task OnDataSourceSelectionChanged(Guid dataSourceId, bool isSelected)
    {
        if (isSelected)
        {
            _selectedDataSourceIds.Add(dataSourceId);
        }
        else
        {
            _selectedDataSourceIds.Remove(dataSourceId);
        }

        await UpdateMapSensorsAsync();
    }

    private async Task SelectAllDataSources()
    {
        if (_dataSources is null) return;
        _selectedDataSourceIds = _dataSources.Select(ds => ds.Id).ToHashSet();
        await UpdateMapSensorsAsync();
    }

    private async Task ClearAllDataSources()
    {
        _selectedDataSourceIds.Clear();
        await UpdateMapSensorsAsync();
    }

    private async Task UpdateMapSensorsAsync()
    {
        if (!_mapInitialized || _sensors is null) return;

        var filteredSensors = _sensors
            .Where(s => _selectedDataSourceIds.Contains(s.SourceId))
            .ToList();

        await MapManager.AddSensorsAsync(filteredSensors);
    }

    public async ValueTask DisposeAsync()
    {
        await _cts.CancelAsync();
        _cts.Dispose();

        if (_mapInitialized)
        {
            await MapManager.DisposeAsync();
        }
    }
}